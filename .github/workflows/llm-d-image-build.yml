name: llm-d image build

on:
  release:
    types: [published]
  pull_request:
    branches: [ main ]

# cancel any prior runs for this workflow and this PR (or branch)
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  packages: write
  attestations: write
  id-token: write

env:
  RELEASE_VERSION: ${{ github.event.release.tag_name || 'latest' }}

jobs:
  # Check if relevant files have changed
  # This job always succeeds, but sets outputs to indicate if we should run builds
  check_changes:
    name: Check if relevant files changed
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.check.outputs.should_run }}
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
      - name: Check for relevant changes
        id: check
        run: |
          if [ "${{ github.event_name }}" = "release" ]; then
            # For release events, always run
            echo "should_run=true" >> $GITHUB_OUTPUT
          else
            # For pull requests, check if relevant files changed
            git fetch origin ${{ github.base_ref }}
            CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD)
            
            # Check if any files match our include patterns
            RELEVANT_FILES=$(echo "$CHANGED_FILES" | grep -E '^docker/vllm/llmd/|^\.github/workflows/llm-d-image-build\.yml$' || true)
            
            if [ -z "$RELEVANT_FILES" ]; then
              echo "No relevant files changed (docker/vllm/llmd/ or workflow file), skipping builds"
              echo "should_run=false" >> $GITHUB_OUTPUT
            else
              echo "Relevant files changed, running builds"
              echo "should_run=true" >> $GITHUB_OUTPUT
            fi
          fi

  build_and_push:
    name: build and push
    needs: check_changes
    if: needs.check_changes.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        gpu:
          - cuda
    steps:
      - uses: actions/checkout@v6

      - name: Aggressive disk space cleanup
        run: ./.github/scripts/free-up-disk-space.sh

      - name: Verify release version
        run: echo "RELEASE_VERSION=$RELEASE_VERSION"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # We only need to log in if we are going to push
      - name: Login to Container Registry
        uses: docker/login-action@v3
        if: ${{ env.RELEASE_VERSION != 'latest' && !github.event.release.prerelease }}
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build the Container Image for ${{ matrix.gpu }}
        uses: docker/build-push-action@v6
        with:
          push: ${{ env.RELEASE_VERSION != 'latest' && !github.event.release.prerelease }}
          #cache-from: type=gha                              # Use github action mechanisms to cache layers
          #cache-to: type=gha                                # Use github action mechanisms to cache layers
          file: docker/vllm/llm-d/Containerfile.${{ matrix.gpu }}
          tags: ghcr.io/ibm/spnl-llm-d-${{ matrix.gpu }}:${{ env.RELEASE_VERSION }},ghcr.io/ibm/spnl-llm-d-${{ matrix.gpu }}:latest
          build-args: |
            SPNL_VERSION=${{ env.RELEASE_VERSION }}
            BUILD_RELEASE_ARG=${{ env.RELEASE_VERSION != 'latest' && !github.event.release.prerelease && '--release' || ' ' }}
