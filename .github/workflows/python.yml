name: python

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

# cancel any prior runs for this workflow and this PR (or branch)
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  
env:
  CARGO_TERM_COLOR: always
  CARGO_INCREMENTAL: 0 # https://corrode.dev/blog/tips-for-faster-ci-builds/#environment-flags-to-disable-incremental-compilation
  CARGO_PROFILE_TEST_DEBUG: 0 # https://corrode.dev/blog/tips-for-faster-ci-builds/#disable-debug-info

jobs:
  # Check if relevant files have changed
  # This job always succeeds, but sets outputs to indicate if we should run tests
  check_changes:
    name: Check if relevant files changed
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.check.outputs.should_run }}
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
      - name: Check for relevant changes
        id: check
        run: |
          if [ "${{ github.event_name }}" = "push" ]; then
            # For push events, always run
            echo "should_run=true" >> $GITHUB_OUTPUT
          else
            # For pull requests, check if any non-ignored files changed
            git fetch origin ${{ github.base_ref }}
            CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD)
            
            # Filter out ignored patterns (markdown files and docker directory)
            RELEVANT_FILES=$(echo "$CHANGED_FILES" | grep -v '\.md$' | grep -v '^docker/' || true)
            
            if [ -z "$RELEVANT_FILES" ]; then
              echo "Only ignored files changed (markdown or docker/), skipping tests"
              echo "should_run=false" >> $GITHUB_OUTPUT
            else
              echo "Relevant files changed, running tests"
              echo "should_run=true" >> $GITHUB_OUTPUT
            fi
          fi

  build_and_test:
    name: python
    needs: check_changes
    if: needs.check_changes.outputs.should_run == 'true'
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        python-version:
          - 3.11
          - 3.12
          - 3.13
        os:
          - ubuntu-latest
          # - windows-latest
          # - macos-latest <-- disabled only because of hopefully transient maturin installation issues https://github.com/PyO3/maturin/issues/2659
    steps:
      - uses: actions/checkout@v6
      # - uses: Swatinem/rust-cache@v2
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v6
        with:
          python-version: ${{ matrix.python-version }}

      - name: create venv
        run: |
          python -mvenv venv
          source venv/bin/activate
          echo "$VIRTUAL_ENV/bin" >> $GITHUB_PATH
          echo "VIRTUAL_ENV=$VIRTUAL_ENV" >> $GITHUB_ENV
          
      - name: install maturin
        run: pip install maturin
      - name: maturin develop
        run: maturin develop -m spnl/Cargo.toml --no-default-features -F pypi

      - name: invoke the python tokenize api
        run: |
          query='{"g": { "model": "ibm-granite/granite-3.3-2b-instruct", "input": {"user": "hello"}}}'
          python -c "import spnl; s = spnl.init(1); spnl.tokenize_query(s, '$query', 27, 10, 31, 16)"
