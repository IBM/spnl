name: python

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

# cancel any prior runs for this workflow and this PR (or branch)
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true
    
env:
  CARGO_TERM_COLOR: always

jobs:
  build_and_test:
    name: python
    strategy:
      matrix:
        python-version:
          - 3.11
          - 3.12
          - 3.13
        os:
          - ubuntu-latest
          - windows-latest
          - macos-latest
    steps:
      - uses: actions/checkout@v4
      - uses: Swatinem/rust-cache@v2
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: create venv
        run: |
          python -mvenv venv
          source venv/bin/activate
          echo "$VIRTUAL_ENV/bin" >> $GITHUB_PATH
          echo "VIRTUAL_ENV=$VIRTUAL_ENV" >> $GITHUB_ENV
          
      - name: install maturin
        run: cargo install cargo-binstall && cargo binstall maturin

      - name: maturin develop
        run: maturin develop -m py/Cargo.toml --no-default-features -F tok

      - name: invoke the python tokenize api
        run: |
          query=$(cat examples/tests/tok_query.json)
          python -c "import spnl_py; s = spnl_py.init(1); spnl_py.tokenize_query(s, '$query', 27, 10, 31, 16)"
